{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'images/lgre.png' %}" />
    
    <!-- Primary Meta Tags -->
    <title>{% block title %}Kikapu - Kenya's Premier Online Marketplace{% endblock %}</title>
    <meta name="title" content="{% block meta_title %}Kikapu - Kenya's Premier Online Marketplace{% endblock %}">
    <meta name="description" content="{% block meta_description %}Buy and sell anything in Kenya. Find great deals on electronics, furniture, cars, fashion and more on Kikapu Marketplace.{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}marketplace, ecommerce, kenya, buy, sell, ads, jiji, jumia, kilimall, olx, pigiame, cheki, nairobi, mombasa, kisumu, nakuru, online shopping, classified ads, 
    secure payments, trusted sellers, cars, phones, laptops, fashion, real estate, land for sale, rent houses, free listings, best deals, marketplace Kenya, ecommerce Kenya, buy and sell Kenya, online shopping Kenya, classified ads Kenya, 
   Kenyan marketplace, Nairobi marketplace, Mombasa deals, Kisumu classifieds, Nakuru sellers, 
   cheap products Kenya, best deals Kenya, second-hand goods Kenya, new items Kenya, 
   electronics Kenya, smartphones Kenya, laptops Kenya, gadgets Kenya, 
   cars Kenya, used cars Kenya, vehicles Kenya, motorcycles Kenya, boda boda Kenya, 
   real estate Kenya, houses for rent Kenya, apartments Kenya, land for sale Kenya, 
   fashion Kenya, men's clothing Kenya, women's fashion Kenya, shoes Kenya, bags Kenya, 
   home & furniture Kenya, appliances Kenya, kitchenware Kenya, 
   jobs Kenya, services Kenya, business opportunities Kenya, 
   OLX Kenya, Jiji Kenya, Jumia Kenya, Kilimall Kenya, Pigiame Kenya, Cheki Kenya, Facebook Marketplace Kenya, 
   secure payments Kenya, escrow Kenya, trusted sellers Kenya, free listings Kenya, 
   sell fast Kenya, buy cheap Kenya, best prices Kenya, auction Kenya, 
   delivery Kenya, same-day delivery Kenya, shop online Kenya, local sellers Kenya, 
   deals of the day, flash sales, Black Friday Kenya, discounts Kenya, 
   Kilimall alternative, Jumia competitor, Kenyan ecommerce sites, 
   online store Kenya, shop Kenya, kikapu marketplace, kikapu Kenya, kenyan marketplace{% endblock %}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="{% block og_title %}{{ meta_title }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ meta_description }}{% endblock %}">
    <meta property="og:image" content="{% static 'images/lgre.png' %}">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta property="twitter:title" content="{% block twitter_title %}{{ meta_title }}{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}{{ meta_description }}{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}{% static 'images/kikapu-social.png' %}{% endblock %}">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ request.build_absolute_uri }}">
    
    <!-- Additional SEO Meta -->
    <meta name="robots" content="index, follow">
    <meta name="author" content="Kikapu">
    <meta name="geo.region" content="KE">
    <meta name="geo.placename" content="Kenya">

    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% csrf_token %}
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />

    <!-- Preload critical fonts -->
    <link rel="preload" href="{% static 'fonts/LineIcons.woff' %}?ibaccn" as="font" type="font/woff" crossorigin>
    <link rel="preload" href="{% static 'fonts/LineIcons.ttf' %}?ibaccn" as="font" type="font/ttf" crossorigin>
    <!-- Icon Fonts -->
    <link rel="stylesheet" href="{% static 'fonts/line-icons.css' %}" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js" integrity="sha512-uKQ39gEGiyUJl4AI6L+ekBdGKpGw4xJ55+xyJG7YFlJokPNYegn9KwQ3P8A7aFQAUtUsAQHep+d/lrGqrbPIDQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Custom Forms CSS -->
    <link rel="stylesheet" href="{% static 'css/ad-form.css' %}" />
    <!-- Main CSS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <!-- Enhanced Styles -->
    <link rel="stylesheet" href="{% static 'css/enhancements.css' %}" />
    <!-- Animate -->
    <link rel="stylesheet" href="{% static 'css/animate.css' %}" />
    <!-- Owl carousel -->
    <link rel="stylesheet" href="{% static 'css/owl.carousel.css' %}" />
    <!-- Slicknav -->
    <link rel="stylesheet" href="{% static 'css/slicknav.css' %}" />
    <!-- Nivo Lightbox -->
    <link rel="stylesheet" href="{% static 'css/nivo-lightbox.css' %}" />
    <!-- Summernote -->
    <link rel="stylesheet" href="{% static 'css/summernote.css' %}" />
    
    <!-- Preload critical fonts -->
    <link rel="preload" href="{% static 'fonts/LineIcons.woff' %}?ibaccn" as="font" type="font/woff" crossorigin>
    <link rel="preload" href="{% static 'fonts/LineIcons.ttf' %}?ibaccn" as="font" type="font/ttf" crossorigin>

    <!-- Loading placeholder styles -->
    <style>
        .content-placeholder {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .content-placeholder.loaded {
            display: none;
        }
    </style>

    <!-- Toastr notifications -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <!-- Core JavaScript -->
    <script src="{% static 'js/jquery-min.js' %}"></script>
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    
    {% block extrahead %}{% endblock %}

    <!-- JSON-LD markup -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Kikapu Marketplace",
        "url": "{{ request.scheme }}://{{ request.get_host }}",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "{{ request.scheme }}://{{ request.get_host }}/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
</head>
<body>
    <!-- Loading placeholder -->
    <div class="content-placeholder">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- CSRF Token for AJAX requests -->
    <form id="csrf-form" style="display: none;">
      {% csrf_token %}
    </form>


    {% include 'header.html' %}
    
    <!-- Toast container -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050"></div>
    
    <main>
        {% block content %}{% endblock %}
    </main>
    
    {% include 'footer.html' %}
    
    <!-- Core JavaScript -->
    <script src="{% static 'js/jquery.counterup.min.js' %}"></script>
    <script src="{% static 'js/waypoints.min.js' %}"></script>
    <script src="{% static 'js/wow.js' %}"></script>
    <script src="{% static 'js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'js/nivo-lightbox.js' %}"></script>
    <script src="{% static 'js/jquery.slicknav.js' %}"></script>
    <script src="{% static 'js/form-validator.min.js' %}"></script>
    <script src="{% static 'js/contact-form-script.min.js' %}"></script>
    <script src="{% static 'js/summernote.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>
    <!-- Enhanced UI Functionality -->
    <script src="{% static 'js/enhancements.js' %}"></script>

    <!-- Form Validation -->
    <script src="{% static 'js/ad-form-validation.js' %}"></script>
    
    <!-- Toastr and Error Handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Configure toastr
        toastr.options = {
            "closeButton": true,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "5000"
        };

        // Hide loading placeholder when page is ready
        window.addEventListener('load', function() {
            document.querySelector('.content-placeholder').classList.add('loaded');
        });

        // Global error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            toastr.error('Something went wrong. Please try again.');
        });

        // Improved CSRF handling
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        // Set up CSRF token for all AJAX requests
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', status, error);
                toastr.error('Network error occurred. Please try again.');
            }
        });
        
        // Check session status periodically
        function checkSession() {
            $.get('/check-session/')
                .done(function(data) {
                    if (!data.authenticated) {
                        toastr.warning('Your session has expired. Please login again.');
                        setTimeout(() => window.location.href = '/login/', 2000);
                    }
                })
                .fail(function(err) {
                    console.error('Session check failed:', err);
                });
        }
        
        setInterval(checkSession, 300000); // Check every 5 minutes
    </script>
    
    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Kikapu Marketplace",
        "url": "{{ request.scheme }}://{{ request.get_host }}",
        "description": "Kenya's Premier Online Marketplace",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "{{ request.scheme }}://{{ request.get_host }}/search?query={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    <!-- jQuery first, then Bootstrap Bundle with Popper -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>

    {% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/location-services.css' %}">
    {% endblock %}

    {% block extra_js %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
    <script src="{% static 'js/location-services.js' %}"></script>
    {% endblock %}
</body>
</html>